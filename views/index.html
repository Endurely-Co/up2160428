<!DOCTYPE html>
<html lang="en">
<head>
    <link rel='stylesheet' href='/stylesheets/navbar.css' />
    <link rel='stylesheet' href='/stylesheets/toast.css' />
    <title id="page-title">Current Race</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3367D6" />

</head>
<body>
<div class="topnav" id="topnav">

    <div  style="float: right;
     margin-right: 10px;">
        <p id="user-type" class="topnav badge">Volunteer</p>
        <button id="logout">Logout</button>
    </div>

<!--    <a id='logout'>Sign out</a>-->
</div>
<div id="content">
</div>
<div id="toast" class="toast"></div>
<script>
    const topNav = document.getElementById("topnav");

    const userType = document.getElementById("user-type");
    const logOut = document.getElementById("logout");
    const toast = document.getElementById('toast');
    const content = document.getElementById("content");
    let selectedTabId = undefined;
    const SELECTED_PAGE_KEY = 'selected_page'
    const START_TAB = 1

    let currentPage = undefined;

    function showToast(message, type){
        toast.textContent = message;
        if(type === 'success'){
            toast.style.backgroundColor = 'green';
        }else{
            toast.style.backgroundColor = 'red';
        }
        toast.className = 'toast show';

        setTimeout((event) => {
            toast.className = 'toast';
        }, 3000);
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js');
    }

    function checkLogin(){
        fetch('/api/check-login', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        }).then((res) => res.json())
            .then((data) => {
                const curPath = window.location.pathname;
                if(data.redirect_url !== curPath){
                    window.location.href = data.redirect_url;
                }
            }).catch((err) => {
            console.log(err, 'error');
        });
    }


    document.addEventListener('DOMContentLoaded', function() {
        checkLogin();
        const message = localStorage.getItem('message');
        if(message){
            showToast(message, 'success');
            localStorage.removeItem('message');
        }

        const userTypeVal = localStorage.getItem('user_type');
        if(userTypeVal){
            const initial = userTypeVal.charAt(0).toUpperCase();
            userType.textContent = `${initial}${ userTypeVal.substring(1).toLowerCase()}`;
        }
        addMenus();
    });

    function initialLoad(){
        let firstLoad = true;
        for(let i =START_TAB; i < topNav.children.length; i++){
            if(topNav.children[i].classList.contains('active')){
                firstLoad = false;
            }
        }
        if(firstLoad){
            const cachedSelection = localStorage.getItem(SELECTED_PAGE_KEY);
            let selectedPage = parseInt(cachedSelection ? cachedSelection : `${START_TAB}`);
            console.log('firstLoad', firstLoad);
            selectedTabId = topNav.children[selectedPage].id;
            loadPage(topNav.children[selectedPage].target);
            topNav.children[selectedPage].className = "active";
        }

    }

    function addMenuClick(){

        for(let i = START_TAB; i < topNav.children.length; i++){
            topNav.children[i].addEventListener('click', function(event){
                if(selectedTabId !== topNav.children[i].id){

                    // Prevent user from moving to over page until race is completed
                    const timerStatus = localStorage.getItem('timer_status');

                    if (timerStatus === 'running'){
                        showToast("Race has started! You can't navigate from this page until race is completed");
                        return;
                    }


                    console.log('selectedTab', topNav.children[i].target);
                    if(selectedTabId !== undefined){
                        document.getElementById(selectedTabId)
                            .classList.remove('active');
                    }

                    // Remove status as state is not running
                    if(timerStatus){
                        localStorage.removeItem('timer_status');
                    }

                    topNav.children[i].className = "active";
                    localStorage.setItem(SELECTED_PAGE_KEY, `${i}`);

                    // Open page based on selected tab
                    loadPage(topNav.children[i].target);
                }
                selectedTabId = topNav.children[i].id;
            });
        }
    }

    function addMenus(){
        fetch('/api/user-type')
        .then(response => response.json())
            .then(menuObj => {
                while (topNav.hasChildNodes() && topNav.children.length > START_TAB){
                    topNav.removeChild(topNav.lastChild);
                }

                menuObj.menus.forEach(menu => {
                    let aMenu = document.createElement('button');
                    aMenu.textContent = menu.name;
                    aMenu.id = menu.id
                    aMenu.target = menu.page;
                    topNav.appendChild(aMenu);
                });

                addMenuClick();
                initialLoad();
            });
    }


    function removeNode(content){
        while (content.hasChildNodes()){
            content.removeChild(content.lastChild);
        }
    }

    function loadPage(htmlUrl) {
        if (currentPage === htmlUrl) {
            return;
        }
        fetch(htmlUrl)
            .then((response) => response.text())
            .then((html) => {
                console.log('DOM fully loaded and parsed');
                const pageFrag = document.createRange().createContextualFragment(html);
                removeNode(content);
                content.appendChild(pageFrag);
               // content.innerHTML = html;
                currentPage = htmlUrl;
            }).catch((error) => {
                console.warn(error);
        });

    }

    logOut.onclick = () => {
        fetch('/api/logout')
            .then(response => response.json())
            .then(logoutRes =>{
                window.location.href = '/login';
                localStorage.clear();
            }).catch((error) =>{
                showToast(error, 'error');
        });
    }

    // document.addEventListener("DOMContentLoaded", () => {
    //     loadPage('dashboard');
    // });

    // homePage.onclick = function () {
    //     loadPage('dashboard');
    //     curPageTitle.textContent = "Current Race";
    //     homePage.className = "active";
    //     //newRacePage.classList.remove("active");
    // }

    // newRacePage.onclick = function () {
    //     curPageTitle.textContent = "Create Race";
    //     loadPage('new-race');
    //     newRacePage.className = "active";
    //     homePage.classList.remove("active");
    // }

</script>


</body>
</html>
