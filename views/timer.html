<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
</head>
<body>

<div id="timerContainer" class="timer-container">
  <p class="race-title">Race Time</p>
  <p class="timer" id="timer">00:00:00.000</p>
  <div class="controls" id="controls">
    <button id="startPause" type="button" class="ctr-button start">Start</button>
    <button id="lapse" type="button" class="ctr-button lap">Lapse</button>
    <button id="stop" type="button" class="ctr-button stop">Stop</button>
  </div>
  <div id="lapses-container"></div>
  <div>
    <ul id="lapses"></ul>
  </div>
  <button type="submit" class="def-button" id="submit-laps-btn" disabled>Submit Laps</button>

</div>

<div class="toast" id="toast"></div>

<script>
  // To prevent Uncaught SyntaxError: redeclaration of const
  if (document.readyState !== "loading") {
    const toast = document.getElementById('toast');
    const startBtn = document.getElementById('startPause');
    const stopBtn = document.getElementById('stop');
    const lapseBtn = document.getElementById('lapse');
    const timer = document.getElementById('timer');
    const lapsesNode = document.getElementById('lapses');
    const topNav = document.getElementById('topnav');
    const controls = document.getElementById('controls');
    const submitLapsBtn = document.getElementById('submit-laps-btn');

    let endTime = undefined;
    let raceLapseData = []
    // const lapseTemplate = document.getElementById("template");

    // let lapses = [];
    let intervalId;
    let startedTime = null;
    let elapsedTime =0;
    let clockNow =0;
    let isRunning = false;
    const startText = 'Start';
    let lapCount = 0;
    let raceId = undefined;

    lapseBtn.addEventListener('click', addNewLapse);
    submitLapsBtn.addEventListener('click', submitLaps);
    stopBtn.addEventListener('click', stopTimer);
    populateCurrentRace();
    getStartTime();

    function submitLaps(){
      // submit laps
      localStorage.setItem('laps', JSON.stringify({
        laps: raceLapseData,
        race_id: raceId
      }));
      for (let i = 0; i < topNav.children.length; i++) {
        topNav.children[i].style.display = 'none';
      }
      window.location.href = '/record-race';
    }

    function addNewLapse(event){
      if (isRunning){
        lapCount += 1;
        let li = document.createElement('li');
        li.className = 'rounded-list';
        li.appendChild(document.createTextNode(`Lap ${lapCount}: ` + timer.textContent));
        lapsesNode.appendChild(li);
        raceLapseData.push(timer.textContent);
      }
    }


    function pauseTimer() {
      if(isRunning && intervalId){
        const nowTime = Date.now();
        startBtn.textContent = "Resume";
        clearInterval(intervalId);
        intervalId = null;
        elapsedTime = nowTime - startedTime;
        updateStartTime(nowTime);
        console.log("pause", clockNow);
        isRunning = false;
      }
    }

    const userTypeVal = localStorage.getItem('user_type');
    console.log('userTypeVal', userTypeVal);
    if(userTypeVal !== 'organiser'){
      controls.className = 'controls hide';
      submitLapsBtn.style.visibility = 'hidden';
    }


    function disableSubmitBtn(){
      submitLapsBtn.disabled = true;
    }

    function enableSubmitBtn(){
      submitLapsBtn.disabled = false;
    }


    async function startTimer() {
      if(!isRunning && !intervalId){
        let nowTime = Date.now();
        //startTime = nowTime.start_time.start_time.split('-')[0] === 'NaN' ? Date.now() : new Date(nowTime.start_time.start_time).getTime();
        updateStartTime(nowTime); // Query time and start
        startedTime = nowTime  - elapsedTime;
        intervalId = setInterval(updateClock, 10)
        startBtn.textContent = "Pause"
        isRunning = true;
        disableSubmitBtn();
      }
    }

    function updateStartTime(startTime){
      // TODO: Add timer state(start, pause, stop)
      fetch('/api/start-race', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          start_time: startTime
        })
      }).then((res) => {
        return res.json();
      }).then((data) => {

        console.log('updateRace---->', data);
      }).catch((err) => {
        console.log('updateRace_err---->', err);
      });
    }

    function updateEndTime(endTime){
      fetch('/api/end-race', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          end_time: endTime
        })
      }).then((res) => {
        return res.json();
      }).then((data) => {

        console.log('updateEndRace---->', data);
      }).catch((err) => {
        console.log('updateEndRace_err---->', err);
      });
    }

    function error(error){
      showToast("Error talking to your gps: " + error.message);
    }

    function success(position){
      formData['longitude'] = position.coords.longitude;
      formData["latitude"] = position.coords.latitude;

      fetch('/api/racer-position', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      }).then(function(response) {
        return response.json();
      }).then(function(races) {
        console.log('login_position', races);
      }).catch(function(error) {
        console.log(error);
      });
    }

    function getStartTime(){
      fetch('/api/start-time', {
        headers: {
          'Content-Type': 'application/json',
        },
        method: 'GET'
      }).then(function(response) {
        return response.json();
      }).then(function(startTime) {
        if (startTime.start_time.start_time.split('-')[0] === 'NaN') return;
        //race.start_time.start_time
        let nowTime = new Date(startTime.start_time.start_time).getTime();
        console.log("nowTime", nowTime, startTime.start_time.start_time);
        //startTime = nowTime.start_time.start_time.split('-')[0] === 'NaN' ? Date.now() : new Date(nowTime.start_time.start_time).getTime();
        updateStartTime(nowTime); // Query time and start
        startedTime = nowTime  - elapsedTime;
        intervalId = setInterval(updateClock, 10)
        startBtn.textContent = "Pause"
        isRunning = true;

      }).catch((error) => {
        console.log('error', error);
      });
    }

    const formData = {};

    monitorUserPosition();


    async function monitorUserPosition() {

      if (localStorage.getItem('user_type') === 'runner') {

        const options = {
          enableHighAccuracy: true,
          timeout: 2000,
          maximumAge: 0
        }

        navigator.geolocation.watchPosition(success, error, options);
      }
    }

    function updateLocation() {
      navigator.geolocation.getCurrentPosition(success, error)
    }

    function stopTimer() {
      startBtn.textContent = startText
      clearInterval(intervalId);
      elapsedTime = 0;
      startedTime =0;
      isRunning = false;
      intervalId = null;
      updateEndTime(endTime);
      updateClock(true);
      localStorage.setItem('timer_status', 'stopped');
      enableSubmitBtn();
    }


    function populateCurrentRace(){
      fetch('/api/current-race', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then((res) => res.json())
              .then((data) => {
                if(data.error){
                  showToast("An error occur", "error");
                }else{
                  raceId = data.data[0].id;
                }
              }).catch((err) => {
        console.log('User not logged inqq', 'error');
      });
    }

    function updateClock(reset = false) {
      if(reset){
        timer.textContent = '00:00:00.000';
        return;
      }
      endTime = Date.now();
      const clockNow = new Date(endTime - startedTime);
      timer.textContent = `${padTime(clockNow.getUTCHours())}:${padTime(clockNow.getUTCMinutes())}:${padTime(clockNow.getUTCSeconds())}.${padTimeMs(clockNow.getMilliseconds())}`;
    }

    function padTimeMs(value){
      const valueStr = value.toString();

      if(valueStr.length < 2){
        return `00${value}`;
      }
      if(valueStr.length < 3){
        return `0${value}`;
      }

      return `${value}`;
    }

    function padTime(value){
      if(value < 10){
        return `0${value}`;
      }
      return `${value}`;
    }

    Number.prototype.toTimeString = function(seconds) {
      let twentyFourHrs = 8.64e7;  // 24*60*60*1000

      let ms = seconds ? this * 1000 : this,
              endPos = ~(4 * !!seconds),  // to trim "Z" or ".sssZ"
              timeString = new Date(ms).toISOString().slice(11, endPos);

      if (ms >= twentyFourHrs) {  // to extract ["hh", "mm:ss[.mss]"]
        let parts = timeString.split(/:(?=\d{2}:)/);
        parts[0] -= -24 * Math.floor(ms / twentyFourHrs);
        timeString = parts.join(":");
      }

      return timeString;
    };

    startBtn.addEventListener('click', async () =>{
      localStorage.setItem('timer_status', 'running');
      console.log('start');
      if([startText, 'Resume'].includes(startBtn.textContent)){
        await startTimer();
      }else{
        pauseTimer();
      }
    });



    function showToast(message, type){
      toast.textContent = message;
      if(type === 'success'){
        toast.style.backgroundColor = 'green';
      }else{
        toast.style.backgroundColor = 'red';
      }
      toast.className = 'toast show';

      setTimeout((event) => {
        toast.className = 'toast';
      }, 3000);
    }

  }

</script>

</body>

</html>
